substitutions:
  name: ws-1p85-hello
  friendly_name: "Waveshare 1.85 Hello"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    build_flags:
      - -DBOARD_HAS_PSRAM
  on_boot:
    priority: 600
    then:
      - script.execute: lcd_power_on
      - delay: 200ms
      - script.execute: lcd_reset_panel
      - delay: 200ms
      - component.update: lcd

esp32:
  board: esp32s3dev
  framework:
    type: esp-idf

logger:
  level: DEBUG

api:

ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap: {}

captive_portal:

# IMPORTANT: I2C corect pentru placa Waveshare (GPIO10/11)
i2c:
  id: bus_i2c
  sda: GPIO11
  scl: GPIO10
  scan: true

# Backlight = GPIO5
output:
  - platform: ledc
    pin: GPIO5
    id: bl_pwm

light:
  - platform: monochromatic
    id: backlight
    name: "${friendly_name} Backlight"
    output: bl_pwm
    restore_mode: ALWAYS_ON
    default_transition_length: 0ms

# Expander pentru reset (EXIO2)
external_components:
  - source:
      type: local
      path: ../components

waveshare_exio:
  id: exio
  i2c_id: bus_i2c
  address: 0x20

st77916_qspi_display:
  id: lcd
  clk_pin: GPIO40
  cs_pin: GPIO21
  d0_pin: GPIO46
  d1_pin: GPIO45
  d2_pin: GPIO42
  d3_pin: GPIO41
  width: 360
  height: 360
  rotation: 0

script:
  - id: lcd_power_on
    then:
      - light.turn_on:
          id: backlight
          brightness: 100%

  - id: lcd_reset_panel
    then:
      - lambda: |-
          id(exio).set_pin_output(2, true);
          id(exio).write_pin(2, true);
      - delay: 30ms
      - lambda: |-
          id(exio).write_pin(2, false);
      - delay: 30ms
      - lambda: |-
          id(exio).write_pin(2, true);

# Render “HELLO”
display:
  - platform: st77916_qspi_display
    id: lcd
    update_interval: 1s
    lambda: |-
      it.fill(Color(0,0,0));
      it.printf(180, 140, id(font_big), Color(255,255,255), TextAlign::CENTER, "Salut!");
      it.printf(180, 190, id(font_small), Color(180,180,180), TextAlign::CENTER, "Waveshare 1.85");
      if (WiFi.isConnected()) {
        it.printf(180, 240, id(font_small), Color(120,220,120), TextAlign::CENTER, "%s", WiFi.localIP().toString().c_str());
      } else {
        it.printf(180, 240, id(font_small), Color(220,120,120), TextAlign::CENTER, "No Wi-Fi");
      }

font:
  - file: "gfonts://Roboto"
    id: font_big
    size: 40
  - file: "gfonts://Roboto"
    id: font_small
    size: 18
